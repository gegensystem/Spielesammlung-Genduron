<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        .modal-leave { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .filter-btn.active { background-color: #06b6d4; color: white; }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">

    <!-- Header -->
    <header class="bg-slate-800/70 backdrop-blur-sm sticky top-0 z-20 shadow-lg">
        <div class="container mx-auto px-4 py-4 max-w-5xl flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-cyan-400">📜🎲 Questboard</h1>
                <p class="text-slate-400 mt-1">Finde Mitspieler für deine nächste Runde.</p>
            </div>
            <div id="user-section">
                <!-- Login/Logout buttons will be inserted here -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-4 max-w-5xl">
        <!-- Verification Banner -->
        <div id="verification-banner" class="hidden bg-yellow-500/20 border border-yellow-500 text-yellow-300 px-4 py-3 rounded-lg text-center mb-4">
            Bitte bestätige deine E-Mail-Adresse. Wir haben dir einen Link geschickt. 
            <button id="resend-verification-btn" class="font-bold underline hover:text-white">Erneut senden</button>
            <span id="resend-feedback" class="ml-2 text-green-400"></span>
        </div>

        <!-- Action & Filter Buttons -->
        <div class="my-6 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="add-game-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 w-full sm:w-auto order-1 sm:order-2">
                (+) Neues Quest anbieten
            </button>
            <div class="flex flex-col lg:flex-row gap-4 w-full lg:w-auto order-2 sm:order-1">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div id="location-quick-filter-container" class="flex gap-2 p-1 bg-slate-800 rounded-lg">
                        <button class="filter-btn active px-3 py-1 rounded-md transition" data-location="">Alle Orte</button>
                        <button class="filter-btn px-3 py-1 rounded-md transition" data-location="Genduron">Genduron</button>
                        <button class="filter-btn px-3 py-1 rounded-md transition" data-location="Linz">Linz</button>
                        <button class="filter-btn px-3 py-1 rounded-md transition" data-location="Graz">Graz</button>
                    </div>
                    <input type="text" id="location-filter" placeholder="Oder Ort hier suchen..." class="bg-slate-800 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full sm:w-auto">
                </div>
                <div id="day-filter-container" class="flex gap-2 p-1 bg-slate-800 rounded-lg">
                    <button class="filter-btn day-filter-btn active px-2 py-1 rounded-md transition" data-day="all">Alle</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="1">Mo</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="2">Di</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="3">Mi</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="4">Do</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="5">Fr</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="6">Sa</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="0">So</button>
                </div>
            </div>
        </div>
        <!-- Game List -->
        <div id="game-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div id="loading-indicator" class="text-center col-span-full py-10">
                <p class="text-slate-400 text-lg">Lade verfügbare Quests...</p>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="text-center py-8 mt-8 text-slate-500 border-t border-slate-800">
        <div class="container mx-auto px-4 max-w-5xl">
            <a href="#" id="imprint-link" class="hover:text-cyan-400 transition">Impressum</a> | 
            <a href="#" id="privacy-link" class="hover:text-cyan-400 transition">Datenschutz</a>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md m-4 modal-enter relative">
            <button id="close-auth-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>
            <div id="auth-tabs" class="flex border-b border-slate-700 mb-6">
                <button data-tab="login" class="auth-tab flex-1 py-2 font-semibold border-b-2 border-cyan-500 text-white">Login</button>
                <button data-tab="register" class="auth-tab flex-1 py-2 font-semibold border-b-2 border-transparent text-slate-400">Registrieren</button>
            </div>
            <form id="login-form">
                <div class="mb-4"><label for="login-email" class="block text-slate-400 mb-2">E-Mail</label><input type="email" id="login-email" class="w-full bg-slate-700 p-2 rounded-md" required autocomplete="username"></div>
                <div class="mb-4"><label for="login-password" class="block text-slate-400 mb-2">Passwort</label><input type="password" id="login-password" class="w-full bg-slate-700 p-2 rounded-md" required autocomplete="current-password"></div>
                <div class="text-center mb-6"><a href="#" id="forgot-password-link" class="text-sm text-cyan-400 hover:underline">Passwort vergessen?</a></div>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg">Einloggen</button>
            </form>
            <form id="register-form" class="hidden">
                 <div class="mb-4"><label for="register-name" class="block text-slate-400 mb-2">Dein Anzeigename</label><input type="text" id="register-name" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                <div class="mb-4"><label for="register-email" class="block text-slate-400 mb-2">E-Mail</label><input type="email" id="register-email" class="w-full bg-slate-700 p-2 rounded-md" required autocomplete="email"></div>
                <div class="mb-4"><label for="register-password" class="block text-slate-400 mb-2">Passwort</label><input type="password" id="register-password" class="w-full bg-slate-700 p-2 rounded-md" required minlength="6" autocomplete="new-password"></div>
                <div class="mb-6"><label for="register-password-confirm" class="block text-slate-400 mb-2">Passwort bestätigen</label><input type="password" id="register-password-confirm" class="w-full bg-slate-700 p-2 rounded-md" required minlength="6" autocomplete="new-password"></div>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg">Registrieren</button>
            </form>
            <p id="auth-error" class="text-red-400 mt-4 text-center h-5"></p>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="add-edit-game-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md m-4 modal-enter">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Neues Quest erstellen</h2>
            <form id="add-edit-game-form">
                <input type="hidden" id="edit-game-id">
                <div class="mb-4"><label for="game-name" class="block text-slate-400 mb-2">Spiel (Quest)</label><input type="text" id="game-name" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                
                <div class="mb-4">
                    <label for="location-type" class="block text-slate-400 mb-2">Spielort</label>
                    <select id="location-type" class="w-full bg-slate-700 p-2 rounded-md">
                        <option value="Genduron">Genduron</option>
                        <option value="other">Anderer Ort...</option>
                    </select>
                </div>
                <div id="custom-location-container" class="mb-4 hidden">
                    <label for="custom-location" class="block text-slate-400 mb-2">Benutzerdefinierter Ort</label>
                    <input type="text" id="custom-location" class="w-full bg-slate-700 p-2 rounded-md" placeholder="z.B. Spieleverein Graz">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label for="game-date" class="block text-slate-400 mb-2">Datum</label><input type="date" id="game-date" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                    <div><label for="game-time" class="block text-slate-400 mb-2">Uhrzeit</label><input type="time" id="game-time" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><label for="total-seats" class="block text-slate-400 mb-2">Plätze</label><input type="number" id="total-seats" min="1" max="20" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                    <div><label for="game-duration" class="block text-slate-400 mb-2">Dauer (Min.)</label><input type="number" id="game-duration" min="10" step="5" class="w-full bg-slate-700 p-2 rounded-md" placeholder="z.B. 90"></div>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-400 mb-2">Optionale Tags</label>
                    <div id="tags-container" class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center"><input type="checkbox" name="tags" value="für Anfänger:innen geeignet" class="h-4 w-4 bg-slate-700 rounded"><span class="ml-2">für Anfänger:innen geeignet</span></label>
                        <label class="flex items-center"><input type="checkbox" name="tags" value="Expertenspiel" class="h-4 w-4 bg-slate-700 rounded"><span class="ml-2">Expertenspiel</span></label>
                        <label class="flex items-center"><input type="checkbox" name="tags" value="Kooperativ" class="h-4 w-4 bg-slate-700 rounded"><span class="ml-2">Kooperativ</span></label>
                        <label class="flex items-center"><input type="checkbox" name="tags" value="alle spielen gleichzeitig" class="h-4 w-4 bg-slate-700 rounded"><span class="ml-2">alle spielen gleichzeitig</span></label>
                    </div>
                </div>
                <div id="organizer-participates-container" class="mb-4"><label class="flex items-center text-slate-400"><input type="checkbox" id="organizer-participates" class="h-4 w-4 bg-slate-700 rounded" checked><span class="ml-2">Ich nehme selbst teil</span></label></div>
                <div id="opening-hours-warning" class="text-yellow-400 text-sm mb-4"></div>
                <div class="flex justify-between items-center">
                    <div>
                        <button type="button" id="delete-game-btn" class="bg-red-800 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition hidden">Löschen</button>
                        <button type="button" id="reactivate-game-btn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition hidden ml-2">Reaktivieren</button>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" id="cancel-add-game" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition">Abbrechen</button>
                        <button type="submit" id="submit-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Erstellen</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Account Modal -->
    <div id="account-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md m-4 modal-enter relative">
             <button id="close-account-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>
             <h2 class="text-2xl font-bold mb-6">Mein Konto</h2>
             <div class="mb-6 space-y-2">
                <p><span class="font-semibold text-slate-400">Name:</span> <span id="account-name"></span></p>
                <p><span class="font-semibold text-slate-400">E-Mail:</span> <span id="account-email"></span></p>
             </div>
             <div class="border-t border-slate-700 pt-6">
                <h3 class="font-semibold text-lg mb-2">Konto löschen</h3>
                <p class="text-slate-400 mb-4">Wenn du dein Konto löschen möchtest, klicke auf den Button. Eine Anfrage mit deinen Daten wird an den Administrator gesendet.</p>
                <button id="request-deletion-btn" class="w-full text-center block bg-red-800 hover:bg-red-700 text-white font-bold py-3 rounded-lg">Löschung anfragen</button>
                <p id="deletion-feedback" class="text-green-400 mt-4 text-center h-5"></p>
             </div>
        </div>
    </div>

<!-- START: Impressum Modal -->
<div id="imprint-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-lg m-4 modal-enter relative">
         <button id="close-imprint-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>
         <h2 class="text-2xl font-bold mb-6">Impressum</h2>
         <div class="text-slate-300 space-y-4 text-sm">
            <h3 class="font-semibold text-slate-100 text-base">Angaben gemäß § 5 ECG</h3>
            <p>
                Dipl.-Ing. Ing. Andreas E. Neuhold, BSc.<br>
                Haushoferstraße 25<br>
                4020 Linz<br>
                Österreich
            </p>
            
            <h3 class="font-semibold text-slate-100 text-base mt-4">Kontakt</h3>
            <p>
                Telefon: +43 677 624 639 01<br>
                E-Mail: andreas.neuhold@gmail.com
            </p>

            <h3 class="font-semibold text-slate-100 text-base mt-4">Zweck der Webseite</h3>
            <p>
                Private, nicht-kommerzielle Plattform zur Organisation von Spieletreffen.
            </p>

            <h3 class="font-semibold text-slate-100 text-base mt-4">Online-Streitbeilegung</h3>
            <p>
                Die Europäische Kommission stellt eine Plattform zur Online-Streitbeilegung (OS) bereit: 
                <a href="https://ec.europa.eu/consumers/odr" target="_blank" rel="noopener noreferrer" class="text-cyan-400 hover:underline">
                    https://ec.europa.eu/consumers/odr
                </a>. 
                Unsere E-Mail-Adresse findest du oben im Impressum. Wir sind nicht bereit oder verpflichtet, an Streitbeilegungsverfahren vor einer Verbraucherschlichtungsstelle teilzunehmen.
            </p>
         </div>
    </div>
</div>
<!-- END: Impressum Modal -->


    <!-- Privacy Modal -->
    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-lg m-4 modal-enter relative">
             <button id="close-privacy-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>
             <h2 class="text-2xl font-bold mb-6">Datenschutzerklärung</h2>
             <div class="text-slate-300 space-y-4 text-sm">
                <p>Der Schutz deiner persönlichen Daten ist uns wichtig. Nachfolgend informieren wir dich über die Verarbeitung deiner personenbezogenen Daten.</p>
                <p><strong class="text-slate-100">Verantwortlicher:</strong> Andreas Neuhold, andreas.neuhold@gmail.com</p>
                <p><strong class="text-slate-100">Zweck der Datenverarbeitung:</strong> Die Verarbeitung deiner Daten (Anzeigename, E-Mail-Adresse) dient ausschließlich der Organisation von Spielrunden über diese Webseite. Dies umfasst das Erstellen von Spielrunden (Quests), die Teilnahme an diesen und die Verwaltung deines Benutzerkontos.</p>
                <p><strong class="text-slate-100">Datenweitergabe:</strong> Deine Daten werden nicht an Dritte weitergegeben.</p>
                <p><strong class="text-slate-100">Speicherung:</strong> Die Datenverarbeitung erfolgt mithilfe einer Firebase Datenbank von Google. Der Serverstandort ist Frankfurt (Deutschland). Mit Google wurde ein Auftragsverarbeitungsvertrag abgeschlossen, der den Schutz deiner Daten gewährleistet.</p>
                <p><strong class="text-slate-100">Deine Rechte:</strong> Du hast das Recht auf Auskunft, Berichtigung und Löschung deiner Daten. Für die Löschung deines Kontos und der damit verbundenen Daten, kontaktiere bitte den oben genannten Verantwortlichen.</p>
                <p><strong class="text-slate-100">Anwendbares Recht und Gerichtsstand:</strong> Es gilt österreichisches Recht. Der Gerichtsstand ist Linz.</p>
             </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, query, where, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAm62EYO-knD48Gv_8h4asS_DsdiCVYhAo",
            authDomain: "spielrunde2.firebaseapp.com",
            projectId: "spielrunde2",
            storageBucket: "spielrunde2.firebasestorage.app",
            messagingSenderId: "718528869080",
            appId: "1:718528869080:web:28fdf441af5187c0725dad",
            measurementId: "G-1HPY49Q9DK"
        };

        let db, auth;
        let currentUser = null;
        let verificationCheckInterval = null;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { console.error("Error initializing Firebase: ", e); }

        const userSection = document.getElementById('user-section');
        const gameList = document.getElementById('game-list');
        const addEditGameModal = document.getElementById('add-edit-game-modal');
        const addEditGameForm = document.getElementById('add-edit-game-form');
        const authModal = document.getElementById('auth-modal');
        const accountModal = document.getElementById('account-modal');
        const imprintModal = document.getElementById('imprint-modal');
        const privacyModal = document.getElementById('privacy-modal');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const addGameBtn = document.getElementById('add-game-btn');
        const cancelAddGameBtn = document.getElementById('cancel-add-game');
        const verificationBanner = document.getElementById('verification-banner');
        const gameDateInput = document.getElementById('game-date');
        const gameTimeInput = document.getElementById('game-time');
        const warningDiv = document.getElementById('opening-hours-warning');
        const locationTypeSelect = document.getElementById('location-type');
        const customLocationContainer = document.getElementById('custom-location-container');
        const locationFilterInput = document.getElementById('location-filter');
        const dayFilterContainer = document.getElementById('day-filter-container');
        const locationQuickFilterContainer = document.getElementById('location-quick-filter-container');

        function showModal(modal) { modal.classList.remove('hidden'); }
        function hideModal(modal) { modal.classList.add('hidden'); }

        function applyFilters() {
            const selectedDays = Array.from(dayFilterContainer.querySelectorAll('.day-filter-btn.active')).map(btn => btn.dataset.day);
            const locationText = locationFilterInput.value.toLowerCase().trim();

            gameList.querySelectorAll('.quest-card').forEach(card => {
                const cardDay = card.dataset.gameDay;
                const cardLocation = card.dataset.location.toLowerCase();

                const dayMatch = selectedDays.includes('all') || selectedDays.length === 0 || selectedDays.includes(cardDay);
                const locationMatch = (locationText === '' || cardLocation.includes(locationText));

                card.style.display = (dayMatch && locationMatch) ? 'flex' : 'none';
            });
        }

        function setMinDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            gameDateInput.min = `${yyyy}-${mm}-${dd}`;
        }

        function checkDateTimeValidity() {
            warningDiv.textContent = '';
            warningDiv.classList.add('hidden');

            if (!gameDateInput.value || !gameTimeInput.value) {
                return true;
            }
            const date = new Date(`${gameDateInput.value}T${gameTimeInput.value}`);
            if (date < new Date()) {
                warningDiv.textContent = 'Ein Quest kann nicht in der Vergangenheit liegen.';
                warningDiv.classList.remove('hidden');
                return false;
            }
            
            if (locationTypeSelect.value === 'Genduron') {
                const day = date.getDay();
                const hours = date.getHours();
                let isValid = false;
                let message = 'Das Genduron ist zu dieser Zeit geschlossen (Mi/Do ab 16, Fr/Sa ab 14 Uhr).';

                if (day === 3 || day === 4) { if (hours >= 16) isValid = true; } 
                else if (day === 5 || day === 6) { if (hours >= 14) isValid = true; }
                
                if (!isValid) {
                    warningDiv.textContent = message;
                    warningDiv.classList.remove('hidden');
                }
                return isValid;
            }
            return true;
        }
        gameDateInput.addEventListener('change', checkDateTimeValidity);
        gameTimeInput.addEventListener('change', checkDateTimeValidity);
        locationTypeSelect.addEventListener('change', () => {
            customLocationContainer.classList.toggle('hidden', locationTypeSelect.value !== 'other');
            checkDateTimeValidity();
        });

        onAuthStateChanged(auth, (user) => {
            if (verificationCheckInterval) clearInterval(verificationCheckInterval);
            
            if (user) {
                currentUser = { uid: user.uid, displayName: user.displayName, email: user.email, emailVerified: user.emailVerified };
                hideModal(authModal);
                updateUserUI(true);

                if (!user.emailVerified) {
                    verificationCheckInterval = setInterval(async () => {
                        const freshUser = auth.currentUser;
                        if (freshUser) {
                            await freshUser.reload();
                            if (freshUser.emailVerified) {
                                clearInterval(verificationCheckInterval);
                                setTimeout(() => {
                                    alert("Deine E-Mail wurde erfolgreich bestätigt. Bitte logge dich nun ein, um fortzufahren.");
                                    signOut(auth);
                                }, 500);
                            }
                        }
                    }, 5000);
                }
            } else {
                currentUser = null;
                updateUserUI(false);
            }
            listenToGames(); 
        });

        function updateUserUI(isLoggedIn) {
            verificationBanner.classList.add('hidden');
            if (isLoggedIn) {
                userSection.innerHTML = `
                    <div class="text-right">
                        <p class="text-slate-300 font-semibold">${currentUser.displayName || currentUser.email}</p>
                        <a href="#" id="account-btn" class="text-sm text-cyan-400 hover:underline">Mein Konto</a> | 
                        <a href="#" id="logout-btn" class="text-sm text-cyan-400 hover:underline">Ausloggen</a>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });
                document.getElementById('account-btn').addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    document.getElementById('account-name').textContent = currentUser.displayName || 'Nicht festgelegt';
                    document.getElementById('account-email').textContent = currentUser.email;
                    document.getElementById('request-deletion-btn').classList.remove('hidden');
                    document.getElementById('request-deletion-btn').disabled = false;
                    document.getElementById('request-deletion-btn').textContent = 'Löschung anfragen';
                    document.getElementById('deletion-feedback').textContent = '';
                    showModal(accountModal); 
                });
                if (!currentUser.emailVerified) {
                    verificationBanner.classList.remove('hidden');
                }
            } else {
                userSection.innerHTML = `<button id="login-register-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">Login / Registrieren</button>`;
                document.getElementById('login-register-btn').addEventListener('click', () => showModal(authModal));
            }
        }
        
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); authError.textContent = ''; signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value).catch(err => { console.error("Login Error:", err.code); authError.textContent = "Falsche E-Mail oder Passwort."; }); });
        registerForm.addEventListener('submit', (e) => { e.preventDefault(); authError.textContent = ''; const displayName = registerForm['register-name'].value; const email = registerForm['register-email'].value; const password = registerForm['register-password'].value; const passwordConfirm = registerForm['register-password-confirm'].value; if (password !== passwordConfirm) { authError.textContent = 'Die Passwörter stimmen nicht überein.'; return; } createUserWithEmailAndPassword(auth, email, password).then(userCredential => { return updateProfile(userCredential.user, { displayName: displayName }).then(() => { sendEmailVerification(userCredential.user); }); }).catch(err => { console.error("Registration Error:", err.code); switch (err.code) { case 'auth/email-already-in-use': authError.textContent = 'Diese E-Mail-Adresse wird bereits verwendet.'; break; case 'auth/invalid-email': authError.textContent = 'Bitte gib eine gültige E-Mail-Adresse ein.'; break; case 'auth/weak-password': authError.textContent = 'Das Passwort muss mindestens 6 Zeichen lang sein.'; break; default: authError.textContent = 'Fehler bei der Registrierung.'; } }); });
        document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); const email = prompt("Bitte gib deine E-Mail-Adresse ein, um dein Passwort zurückzusetzen:"); if (email) { sendPasswordResetEmail(auth, email).then(() => { alert("Eine E-Mail zum Zurücksetzen des Passworts wurde an " + email + " gesendet."); }).catch((error) => { console.error("Password Reset Error:", error.code); alert("Fehler: Die E-Mail konnte nicht gesendet werden. Bitte prüfe die Adresse."); }); } });
        document.getElementById('resend-verification-btn').addEventListener('click', () => { if (auth.currentUser) { sendEmailVerification(auth.currentUser).then(() => { const feedback = document.getElementById('resend-feedback'); feedback.textContent = 'Gesendet!'; setTimeout(() => feedback.textContent = '', 3000); }); } });
        document.getElementById('auth-tabs').addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { const tab = e.target.dataset.tab; document.querySelectorAll('.auth-tab').forEach(t => { t.classList.remove('border-cyan-500', 'text-white'); t.classList.add('border-transparent', 'text-slate-400'); }); e.target.classList.add('border-cyan-500', 'text-white'); if (tab === 'login') { loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); } else { loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); } } });
        document.getElementById('close-auth-modal').addEventListener('click', () => hideModal(authModal));
        document.getElementById('close-account-modal').addEventListener('click', () => hideModal(accountModal));
        document.getElementById('imprint-link').addEventListener('click', (e) => { e.preventDefault(); showModal(imprintModal); });
        document.getElementById('privacy-link').addEventListener('click', (e) => { e.preventDefault(); showModal(privacyModal); });
        document.getElementById('close-imprint-modal').addEventListener('click', () => hideModal(imprintModal));
        document.getElementById('close-privacy-modal').addEventListener('click', () => hideModal(privacyModal));

        document.getElementById('request-deletion-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            if (confirm("Bist du sicher, dass du die Löschung deines Kontos anfragen möchtest?")) {
                const button = document.getElementById('request-deletion-btn');
                button.disabled = true;
                button.textContent = 'Sende Anfrage...';
                const deletionData = {
                    subject: `Löschanfrage für Questboard: ${currentUser.displayName}`,
                    displayName: currentUser.displayName,
                    email: currentUser.email,
                    uid: currentUser.uid,
                    requestDate: new Date().toLocaleString('de-DE')
                };
                const emailEndpoint = 'https://formspree.io/f/myzdgawa';
                try {
                    const response = await fetch(emailEndpoint, {
                        method: 'POST',
                        body: JSON.stringify(deletionData),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        document.getElementById('deletion-feedback').textContent = "Anfrage wird innerhalb von 6 Tagen ausgeführt.";
                        button.classList.add('hidden');
                    } else { throw new Error('Network response was not ok.'); }
                } catch (error) {
                    console.error('Error sending deletion request:', error);
                    alert('Die Löschanfrage konnte nicht gesendet werden. Bitte versuche es später erneut oder kontaktiere Andreas direkt.');
                    button.disabled = false;
                    button.textContent = 'Löschung anfragen';
                }
            }
        });

        let unsubscribeFromGames = null;
        function listenToGames() { if (unsubscribeFromGames) unsubscribeFromGames(); const gamesCol = collection(db, "spielrunden"); const q = query(gamesCol, where("dateTime", ">=", Timestamp.now()), orderBy("dateTime", "asc")); unsubscribeFromGames = onSnapshot(q, (snapshot) => { try { const loadingIndicator = document.getElementById('loading-indicator'); if (loadingIndicator) loadingIndicator.classList.add('hidden'); gameList.innerHTML = ''; if (snapshot.empty) { gameList.innerHTML = '<p class="text-slate-400 text-center col-span-full">Keine Quests verfügbar.</p>'; } else { snapshot.docs.forEach(doc => gameList.appendChild(renderGame(doc))); applyFilters(); } } catch (error) { console.error("Error during snapshot processing:", error); } }, (error) => { console.error("Firestore Error:", error); gameList.innerHTML = '<p class="text-red-400 text-center col-span-full">Fehler beim Laden der Quests. Prüfe die Datenbank-Regeln.</p>'; }); }
        listenToGames();

        function renderGame(doc) { const game = doc.data(); const gameId = doc.id; const isCreator = currentUser && currentUser.uid === game.creatorId; const isParticipant = currentUser && game.participants.some(p => p.uid === currentUser.uid); const participantsCount = game.participants.length; const freeSeats = game.totalSeats - participantsCount; const isFull = freeSeats <= 0; const isCancelled = game.cancelled || false; const gameDate = game.dateTime.toDate(); const formattedDate = gameDate.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit' }); const formattedTime = gameDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }); const card = document.createElement('div'); card.className = `quest-card bg-slate-800 rounded-lg shadow-lg p-6 flex flex-col relative`; card.dataset.gameDay = gameDate.getDay(); card.dataset.location = game.location; let participantsHTML = game.participants.map(p => `<span class="bg-slate-700 text-slate-300 text-sm font-medium mr-2 mb-2 px-2.5 py-1 rounded-full flex items-center">${p.displayName}${isCreator ? `<button class="remove-player-btn ml-2 text-red-400 hover:text-red-200" data-game-id="${gameId}" data-player-uid="${p.uid}" data-player-name="${p.displayName}">×</button>` : ''}</span>`).join(''); let tagsHTML = (game.tags && game.tags.length > 0) ? game.tags.map(tag => `<span class="bg-cyan-800 text-cyan-200 text-xs font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full">${tag}</span>`).join('') : ''; card.innerHTML = `${isCancelled ? '<div class="absolute inset-0 bg-red-900/70 flex items-center justify-center rounded-lg z-0"><span class="text-2xl font-bold text-white transform -rotate-12">ABGESAGT</span></div>' : ''}<div class="flex-grow"><div class="flex justify-between items-start"><h3 class="text-2xl font-bold text-cyan-400 mb-2">${game.gameName}</h3>${isCreator ? `<div class="flex items-center gap-2 text-xl relative z-10"><button class="edit-game-btn text-slate-500 hover:text-cyan-400" title="Quest bearbeiten" data-game-id="${gameId}">✏️</button><button class="cancel-game-btn text-slate-500 hover:text-red-400" title="Quest absagen" data-game-id="${gameId}">⨷</button></div>` : ''}</div><p class="text-slate-400 mb-2">von <span class="font-semibold">${game.creatorName}</span></p><div class="flex items-center text-slate-400 mb-4 text-sm"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg><span>${game.location}</span></div><div class="flex flex-wrap mb-4">${tagsHTML}</div><div class="flex items-center text-slate-300 mb-2"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z"></path></svg><span>${formattedDate} um ${formattedTime} Uhr</span></div>${game.duration ? `<div class="flex items-center text-slate-400 mb-4"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path></svg><span>ca. ${game.duration} Minuten</span></div>` : ''}<div class="flex items-center text-slate-300 mb-6"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 1 1 0 5.292M15 21H3v-1a6 6 0 0 1 12 0v1Zm0 0h6v-1a6 6 0 0 0-9-5.197M15 21a6 6 0 0 0-9-5.197m0 0A5.995 5.995 0 0 0 12 12a5.995 5.995 0 0 0-3-5.197M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path></svg><span class="${isFull ? 'text-red-400' : 'text-green-400'} font-semibold">${freeSeats > 0 ? `${freeSeats} Plätze frei` : 'Runde ist voll'}</span></div><h4 class="font-semibold text-slate-300 mb-2">Teilnehmer (${participantsCount}/${game.totalSeats}):</h4><div class="flex flex-wrap">${participantsHTML}</div></div><div class="mt-6"><button class="join-leave-btn w-full font-bold py-3 px-4 rounded-lg transition ${isCancelled ? 'bg-slate-700 text-slate-500' : (isParticipant ? 'bg-amber-600 hover:bg-amber-700' : (isFull ? 'bg-slate-700 text-slate-500' : 'bg-cyan-500 hover:bg-cyan-600'))}" data-game-id="${gameId}" ${isCancelled || (isFull && !isParticipant) ? 'disabled' : ''}>${isCancelled ? 'Abgesagt' : (isParticipant ? 'Verlassen' : (isFull ? 'Voll' : 'Ich bin dabei!'))}</button></div>`; return card; }
        
        cancelAddGameBtn.addEventListener('click', () => hideModal(addEditGameModal));
        dayFilterContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('day-filter-btn')) {
                const clickedDay = e.target.dataset.day;
                if (clickedDay === 'all') {
                    dayFilterContainer.querySelectorAll('.day-filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                } else {
                    dayFilterContainer.querySelector('[data-day="all"]').classList.remove('active');
                    e.target.classList.toggle('active');
                    if (dayFilterContainer.querySelectorAll('.day-filter-btn.active').length === 0) {
                        dayFilterContainer.querySelector('[data-day="all"]').classList.add('active');
                    }
                }
                applyFilters();
            }
        });
        locationFilterInput.addEventListener('input', () => {
            locationQuickFilterContainer.querySelector('.active')?.classList.remove('active');
            applyFilters();
        });
        locationQuickFilterContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                locationQuickFilterContainer.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                locationFilterInput.value = e.target.dataset.location;
                applyFilters();
            }
        });

        addEditGameForm.addEventListener('submit', async (e) => { e.preventDefault(); if (!checkDateTimeValidity()) return; const gameId = document.getElementById('edit-game-id').value; const selectedTags = Array.from(document.querySelectorAll('#tags-container input:checked')).map(el => el.value); const location = locationTypeSelect.value === 'Genduron' ? 'Genduron' : document.getElementById('custom-location').value.trim(); const gameData = { gameName: addEditGameForm['game-name'].value.trim(), location: location, dateTime: Timestamp.fromDate(new Date(`${addEditGameForm['game-date'].value}T${addEditGameForm['game-time'].value}`)), totalSeats: parseInt(addEditGameForm['total-seats'].value), duration: addEditGameForm['game-duration'].value.trim(), tags: selectedTags }; try { if (gameId) { await updateDoc(doc(db, "spielrunden", gameId), gameData); } else { gameData.creatorId = currentUser.uid; gameData.creatorName = currentUser.displayName; gameData.participants = addEditGameForm['organizer-participates'].checked ? [{ uid: currentUser.uid, displayName: currentUser.displayName }] : []; gameData.cancelled = false; await addDoc(collection(db, "spielrunden"), gameData); } hideModal(addEditGameModal); } catch (error) { console.error("Error saving document: ", error); } });
        gameList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const gameId = target.dataset.gameId;
            if (!currentUser) { showModal(authModal); return; }
            if (!currentUser.emailVerified) { verificationBanner.classList.remove('hidden'); alert("Bitte bestätige zuerst deine E-Mail-Adresse, um Aktionen auszuführen."); return; }
            
            const gameRef = doc(db, "spielrunden", gameId);
            try {
                if (target.classList.contains('join-leave-btn')) {
                    const docSnap = await getDoc(gameRef);
                    const participants = docSnap.data().participants || [];
                    const participantIndex = participants.findIndex(p => p.uid === currentUser.uid);
                    
                    let newParticipants;
                    if (participantIndex > -1) {
                        newParticipants = participants.filter(p => p.uid !== currentUser.uid);
                    } else {
                        const participantData = { uid: currentUser.uid, displayName: currentUser.displayName };
                        newParticipants = [...participants, participantData];
                    }
                    await updateDoc(gameRef, { participants: newParticipants });

                } else if (target.classList.contains('remove-player-btn')) {
                    const docSnap = await getDoc(gameRef);
                    const participants = docSnap.data().participants || [];
                    const playerUidToRemove = target.dataset.playerUid;
                    const newParticipants = participants.filter(p => p.uid !== playerUidToRemove);
                    await updateDoc(gameRef, { participants: newParticipants });

                } else if (target.classList.contains('edit-game-btn')) { 
                    const docSnap = await getDoc(gameRef); 
                    if (docSnap.exists()) { const game = docSnap.data(); setMinDate(); document.getElementById('edit-game-id').value = gameId; document.getElementById('game-name').value = game.gameName; if (game.location === 'Genduron') { locationTypeSelect.value = 'Genduron'; customLocationContainer.classList.add('hidden'); } else { locationTypeSelect.value = 'other'; document.getElementById('custom-location').value = game.location; customLocationContainer.classList.remove('hidden'); } const date = game.dateTime.toDate(); document.getElementById('game-date').value = date.toISOString().split('T')[0]; document.getElementById('game-time').value = date.toTimeString().slice(0,5); document.getElementById('total-seats').value = game.totalSeats; document.getElementById('game-duration').value = game.duration || ''; document.querySelectorAll('#tags-container input').forEach(checkbox => checkbox.checked = (game.tags && game.tags.includes(checkbox.value))); document.getElementById('modal-title').textContent = 'Quest bearbeiten'; document.getElementById('submit-btn').textContent = 'Änderungen speichern'; document.getElementById('delete-game-btn').classList.remove('hidden'); document.getElementById('organizer-participates-container').style.display = 'none'; document.getElementById('reactivate-game-btn').classList.toggle('hidden', !game.cancelled); showModal(addEditGameModal); } 
                } else if (target.classList.contains('cancel-game-btn')) { 
                    if (confirm('Möchtest du dieses Quest wirklich absagen?')) { await updateDoc(gameRef, { cancelled: true }); } 
                }
            } catch (error) {
                console.error("Fehler bei der Aktion:", error);
                alert("Ein Fehler ist aufgetreten. Bitte versuche es erneut.");
            }
        });
        addGameBtn.addEventListener('click', () => { if (!currentUser) { showModal(authModal); return; } if (!currentUser.emailVerified) { alert("Bitte bestätige zuerst deine E-Mail-Adresse, um ein Quest zu erstellen."); return; } addEditGameForm.reset(); setMinDate(); locationTypeSelect.value = 'Genduron'; customLocationContainer.classList.add('hidden'); checkDateTimeValidity(); document.getElementById('edit-game-id').value = ''; document.getElementById('modal-title').textContent = 'Neues Quest erstellen'; document.getElementById('submit-btn').textContent = 'Erstellen'; document.getElementById('delete-game-btn').classList.add('hidden'); document.getElementById('reactivate-game-btn').classList.add('hidden'); document.getElementById('organizer-participates-container').style.display = 'block'; showModal(addEditGameModal); });
        document.getElementById('delete-game-btn').addEventListener('click', async () => { const gameId = document.getElementById('edit-game-id').value; if (gameId && confirm('Bist du sicher, dass du dieses Quest endgültig löschen möchtest?')) { await deleteDoc(doc(db, "spielrunden", gameId)); hideModal(addEditGameModal); } });
        document.getElementById('reactivate-game-btn').addEventListener('click', async () => { const gameId = document.getElementById('edit-game-id').value; await updateDoc(doc(db, "spielrunden", gameId), { cancelled: false }); hideModal(addEditGameModal); });
    </script>
</body>
</html>
