<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questboard</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-enter, .toast-enter { animation: fadeIn 0.3s ease-out; }
        .modal-leave, .toast-leave { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .filter-btn.active { background-color: #06b6d4; color: white; }
        .highlight-quest {
            transition: box-shadow 0.5s ease-in-out;
            box-shadow: 0 0 20px 5px #06b6d4;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.6) brightness(1.5);
        }
        #toast-container { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 100; }
        .toast { background-color: #06b6d4; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">

    <!-- Header -->
    <header class="bg-slate-800/70 backdrop-blur-sm sticky top-0 z-20 shadow-lg">
        <div class="container mx-auto px-4 py-4 max-w-7xl flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-cyan-400">üé≤ Questboard</h1>
                <p class="text-slate-400 mt-1">Finde Mitspieler f√ºr deine n√§chste Runde.</p>
            </div>
            <div class="flex items-center gap-4">
                <a href="https://www.paypal.com/ncp/payment/Q47XPP7KQQVLQ" target="_blank" rel="noopener noreferrer" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-transform transform hover:scale-105">
                    <span>‚òï</span>
                    <span class="hidden sm:inline">Kaffee ausgeben</span>
                </a>
                <button id="menu-toggle-btn" class="p-2 rounded-md hover:bg-slate-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Side Menu -->
    <div id="side-menu" class="fixed top-0 right-0 h-full w-64 bg-slate-800 shadow-2xl transform translate-x-full transition-transform z-30">
        <div id="side-menu-content" class="p-6"></div>
    </div>
    <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-4 max-w-7xl">
        <div id="verification-banner" class="hidden bg-yellow-500/20 border border-yellow-500 text-yellow-300 px-4 py-3 rounded-lg text-center mb-4">
            Bitte best√§tige deine E-Mail-Adresse. Wir haben dir einen Link geschickt. 
            <button id="resend-verification-btn" class="font-bold underline hover:text-white disabled:opacity-50 disabled:cursor-not-allowed">Erneut senden</button>
            <span id="resend-feedback" class="ml-2 text-green-400"></span>
        </div>

        <!-- Action & Filter Buttons -->
        <div class="my-6 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="add-game-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 w-full sm:w-auto order-1 sm:order-2">
                (+) Neues Quest anbieten
            </button>
            <div class="flex flex-col lg:flex-row gap-4 w-full lg:w-auto order-2 sm:order-1">
                <div class="flex flex-col sm:flex-row gap-4">
                     <div class="flex flex-wrap gap-4">
                         <input type="text" id="name-filter" placeholder="Nach Spiel suchen..." class="bg-slate-800 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full sm:w-auto" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');">
                         <input type="text" id="location-filter" placeholder="Nach Ort suchen..." class="bg-slate-800 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full sm:w-auto" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');">
                         <div class="relative">
                            <input type="date" id="date-filter" class="bg-slate-800 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full sm:w-auto pr-8">
                            <button id="clear-date-filter" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white hidden text-xl font-bold">&times;</button>
                        </div>
                     </div>
                </div>
                <div id="day-filter-container" class="flex gap-2 p-1 bg-slate-800 rounded-lg">
                    <button class="filter-btn day-filter-btn active px-2 py-1 rounded-md transition" data-day="all">Alle</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="1">Mo</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="2">Di</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="3">Mi</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="4">Do</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="5">Fr</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="6">Sa</button>
                    <button class="filter-btn day-filter-btn px-2 py-1 rounded-md transition" data-day="0">So</button>
                </div>
            </div>
        </div>
        <div id="location-filter-container" class="mb-6 flex flex-wrap justify-center gap-2 p-2 bg-slate-800/50 rounded-lg">
            <button class="filter-btn location-filter-btn active px-3 py-1 rounded-md transition" data-location="all">Alle Orte</button>
            <button class="filter-btn location-filter-btn px-3 py-1 rounded-md transition" data-location="Genduron">Genduron</button>
            <button class="filter-btn location-filter-btn px-3 py-1 rounded-md transition" data-location="Knobelritter">Knobelritter</button>
            <button class="filter-btn location-filter-btn px-3 py-1 rounded-md transition" data-location="Spieleversum">Spieleversum</button>
            <button class="filter-btn location-filter-btn px-3 py-1 rounded-md transition" data-location="Games Toys and more">Games Toys and more</button>
            <button class="filter-btn location-filter-btn px-3 py-1 rounded-md transition" data-location="Brettspielfreunde">Brettspielfreunde</button>
        </div>
       
        <div id="quest-list-container">
            <div id="game-list-cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            <div id="loading-indicator" class="text-center col-span-full py-10">
                 <p class="text-slate-400 text-lg">Lade verf√ºgbare Quests...</p>
            </div>
        </div>

        <div id="pagination-controls" class="mt-6 flex justify-center items-center gap-4 text-slate-400"></div>
    </main>
   
    <footer class="text-center py-8 mt-8 text-slate-500 border-t border-slate-800">
        <div class="container mx-auto px-4 max-w-5xl space-x-4">
            <a href="#" id="imprint-link" class="hover:text-cyan-400 transition">Impressum</a>
            <span>|</span>
            <a href="#" id="privacy-link" class="hover:text-cyan-400 transition">Datenschutz</a>
        </div>
    </footer>

    <!-- All Modals -->
    <div id="shared-quest-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div id="shared-quest-content" class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-lg m-4 modal-enter relative"></div>
    </div>
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md m-4 modal-enter relative">
            <button id="close-auth-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>
            <div id="auth-tabs" class="flex border-b border-slate-700 mb-6">
                <button data-tab="login" class="auth-tab flex-1 py-2 font-semibold border-b-2 border-cyan-500 text-white">Login</button>
                <button data-tab="register" class="auth-tab flex-1 py-2 font-semibold border-b-2 border-transparent text-slate-400">Registrieren</button>
            </div>
            <form id="login-form">
                <div class="mb-4"><label for="login-email" class="block text-slate-400 mb-2">E-Mail</label><input type="email" id="login-email" class="w-full bg-slate-700 p-2 rounded-md" required autocomplete="username"></div>
                <div class="mb-4"><label for="login-password" class="block text-slate-400 mb-2">Passwort</label><input type="password" id="login-password" class="w-full bg-slate-700 p-2 rounded-md" required autocomplete="current-password"></div>
                <div class="text-center mb-6"><a href="#" id="forgot-password-link" class="text-sm text-cyan-400 hover:underline">Passwort vergessen?</a></div>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg transition-colors disabled:bg-slate-600">Einloggen</button>
            </form>
            <form id="register-form" class="hidden">
                 <div class="mb-4"><label for="register-name" class="block text-slate-400 mb-2">Dein Anzeigename</label><input type="text" id="register-name" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                <div class="mb-4"><label for="register-email" class="block text-slate-400 mb-2">E-Mail</label><input type="email" id="register-email" class="w-full bg-slate-700 p-2 rounded-md" required autocomplete="email"></div>
                <div class="mb-4"><label for="register-password" class="block text-slate-400 mb-2">Passwort</label><input type="password" id="register-password" class="w-full bg-slate-700 p-2 rounded-md" required minlength="6" autocomplete="new-password"></div>
                <div class="mb-6"><label for="register-password-confirm" class="block text-slate-400 mb-2">Passwort best√§tigen</label><input type="password" id="register-password-confirm" class="w-full bg-slate-700 p-2 rounded-md" required minlength="6" autocomplete="new-password"></div>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg">Registrieren</button>
            </form>
            <p id="auth-error" class="text-red-400 mt-4 text-center h-5"></p>
        </div>
    </div>
    <div id="add-edit-game-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md m-4 modal-enter">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Neues Quest erstellen</h2>
            <form id="add-edit-game-form">
                <input type="hidden" id="edit-game-id">
                <div class="mb-4"><label for="game-name" class="block text-slate-400 mb-2">Spiel (Quest)</label><input type="text" id="game-name" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                <div class="mb-4">
                    <label for="location-type" class="block text-slate-400 mb-2">Spielort</label>
                    <select id="location-type" class="w-full bg-slate-700 p-2 rounded-md">
                        <option value="Genduron">Genduron</option>
                        <option value="Knobelritter">Knobelritter</option>
                        <option value="Spieleversum">Spieleversum</option>
                        <option value="Games Toys and more">Games Toys and more</option>
                        <option value="Brettspielfreunde">Brettspielfreunde</option>
                        <option value="other">Anderer Ort...</option>
                    </select>
                </div>
                <div id="custom-location-container" class="mb-4 hidden"><label for="custom-location" class="block text-slate-400 mb-2">Benutzerdefinierter Ort</label><input type="text" id="custom-location" class="w-full bg-slate-700 p-2 rounded-md" placeholder="z.B. Spieleverein Graz"></div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label for="game-date" class="block text-slate-400 mb-2">Datum</label><input type="date" id="game-date" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                    <div><label for="game-time" class="block text-slate-400 mb-2">Uhrzeit</label><input type="time" id="game-time" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><label for="total-seats" class="block text-slate-400 mb-2">Pl√§tze</label><input type="number" id="total-seats" min="1" max="20" class="w-full bg-slate-700 p-2 rounded-md" required></div>
                    <div><label for="game-duration" class="block text-slate-400 mb-2">Dauer (Min.)</label><input type="number" id="game-duration" min="10" step="5" class="w-full bg-slate-700 p-2 rounded-md" placeholder="z.B. 90"></div>
                </div>
                <div class="mb-4"><label class="block text-slate-400 mb-2">Optionale Tags</label><div id="tags-container" class="grid grid-cols-2 gap-2 text-sm"><label class="flex items-center"><input type="checkbox" name="tags" value="f√ºr Anf√§nger:innen geeignet" class="h-4 w-4 bg-slate-700 rounded"><span class="ml-2">f√ºr Anf√§nger:innen geeignet</span></label><label class="flex items-center"><input type="checkbox" name="tags" value="Expertenspiel" class="h-4 w-4 bg-slate-700 rounded"><span class="ml-2">Expertenspiel</span></label><label class="flex items-center"><input type="checkbox" name="tags" value="Kooperativ" class="h-4 w-4 bg-slate-700 rounded"><span class="ml-2">Kooperativ</span></label><label class="flex items-center"><input type="checkbox" name="tags" value="Regeln werden erkl√§rt!" class="h-4 w-4 bg-slate-700 rounded"><span class="ml-2">Regeln werden erkl√§rt!</span></label></div></div>
                <div id="organizer-participates-container" class="mb-4"><label class="flex items-center text-slate-400"><input type="checkbox" id="organizer-participates" class="h-4 w-4 bg-slate-700 rounded" checked><span class="ml-2">Ich nehme selbst teil</span></label></div>
                <div class="flex justify-between items-center">
                    <div><button type="button" id="delete-game-btn" class="bg-red-800 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition hidden">L√∂schen</button><button type="button" id="reactivate-game-btn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition hidden ml-2">Reaktivieren</button></div>
                    <div class="flex gap-4"><button type="button" id="cancel-add-game" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition">Abbrechen</button><button type="submit" id="submit-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Erstellen</button></div>
                </div>
            </form>
        </div>
    </div>
    <div id="account-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md m-4 modal-enter relative">
             <button id="close-account-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>
             <h2 class="text-2xl font-bold mb-6">Mein Konto</h2>
             <div class="mb-6 space-y-2"><p><span class="font-semibold text-slate-400">Name:</span> <span id="account-name"></span></p><p><span class="font-semibold text-slate-400">E-Mail:</span> <span id="account-email"></span></p></div>
             <div class="border-t border-slate-700 pt-6"><h3 class="font-semibold text-lg mb-2">Konto l√∂schen</h3><p class="text-slate-400 mb-4">Wenn du dein Konto l√∂schen m√∂chtest, klicke auf den Button. Eine Anfrage mit deinen Daten wird an den Administrator gesendet.</p>
                <form id="deletion-request-form">
                    <button id="request-deletion-btn" type="submit" class="w-full text-center block bg-red-800 hover:bg-red-700 text-white font-bold py-3 rounded-lg disabled:bg-slate-600 disabled:cursor-not-allowed">L√∂schung anfragen</button>
                </form>
                <p id="deletion-feedback" class="text-green-400 mt-4 text-center h-5"></p>
            </div>
        </div>
    </div>
    <div id="imprint-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-lg m-4 modal-enter relative flex flex-col">
             <button id="close-imprint-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl z-10">&times;</button>
             <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Impressum</h2>
             <div class="text-slate-300 space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                 <h3 class="font-semibold text-slate-100 text-base">Angaben gem√§√ü ¬ß 5 ECG</h3><p>Dipl.-Ing. Ing. Andreas E. Neuhold, BSc.<br>Haushoferstra√üe 25<br>4020 Linz<br>√ñsterreich</p>
                 <h3 class="font-semibold text-slate-100 text-base mt-4">Kontakt</h3><p>Telefon: +43 677 624 639 01<br>E-Mail: andreas.neuhold@gmail.com</p>
                 <h3 class="font-semibold text-slate-100 text-base mt-4">Ausrichtung der Webseite</h3><p>Private, nicht-kommerzielle Plattform zur Organisation von Spieletreffen. Die Nutzung der Seite ist kostenlos. Es besteht die M√∂glichkeit, das Projekt durch freiwillige Zuwendungen (Trinkgelder) zu unterst√ºtzen, die √ºber externe Zahlungsdienstleister abgewickelt werden.</p>
                 <h3 class="font-semibold text-slate-100 text-base mt-4">Online-Streitbeilegung</h3><p>Die Europ√§ische Kommission stellt eine Plattform zur Online-Streitbeilegung (OS) bereit: <a href="https://ec.europa.eu/consumers/odr" target="_blank" rel="noopener noreferrer" class="text-cyan-400 hover:underline">https://ec.europa.eu/consumers/odr</a>. Unsere E-Mail-Adresse findest du oben im Impressum. Wir sind nicht bereit oder verpflichtet, an Streitbeilegungsverfahren vor einer Verbraucherschlichtungsstelle teilzunehmen.</p>
             </div>
        </div>
    </div>
    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-lg m-4 modal-enter relative flex flex-col">
             <button id="close-privacy-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl z-10">&times;</button>
             <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Datenschutzerkl√§rung</h2>
             <div class="text-slate-300 space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-4">
                 <p>Der Schutz deiner pers√∂nlichen Daten ist uns wichtig. Nachfolgend informieren wir dich √ºber die Verarbeitung deiner personenbezogenen Daten.</p>
                 <p><strong class="text-slate-100">Verantwortlicher:</strong> Andreas Neuhold, andreas.neuhold@gmail.com</p>
                 <p><strong class="text-slate-100">Zweck der Datenverarbeitung:</strong> Die Verarbeitung deiner Daten (Anzeigename, E-Mail-Adresse) dient ausschlie√ülich der Organisation von Spielrunden √ºber diese Webseite. Dies umfasst das Erstellen von Spielrunden (Quests), die Teilnahme an diesen und die Verwaltung deines Benutzerkontos.</p>
                 <p><strong class="text-slate-100">Datenweitergabe:</strong> Deine Daten werden grunds√§tzlich nicht an Dritte weitergegeben.</p>
                 <p><strong class="text-slate-100">Freiwillige Zuwendungen (Trinkgelder):</strong> Auf unserer Webseite besteht die M√∂glichkeit, das Projekt durch freiwillige Zuwendungen zu unterst√ºtzen. Wenn du dich daf√ºr entscheidest, wirst du zu einem externen Zahlungsdienstleister (z.B. PayPal) weitergeleitet. Wir selbst erheben oder speichern keine Zahlungsdaten wie Kreditkartennummern oder Bankverbindungen. Die gesamte Zahlungsabwicklung erfolgt ausschlie√ülich √ºber die sicheren Server des jeweiligen Anbieters. Es gelten die Datenschutzbestimmungen des jeweiligen Zahlungsdienstleisters.</p>
                 <p><strong class="text-slate-100">Speicherung:</strong> Die Datenverarbeitung erfolgt mithilfe einer Firebase Datenbank von Google. Der Serverstandort ist Frankfurt (Deutschland). Mit Google wurde ein Auftragsverarbeitungsvertrag abgeschlossen, der den Schutz deiner Daten gew√§hrleistet.</p>
                 <p><strong class="text-slate-100">Deine Rechte:</strong> Du hast das Recht auf Auskunft, Berichtigung und L√∂schung deiner Daten. F√ºr die L√∂schung deines Kontos und der damit verbundenen Daten, kontaktiere bitte den oben genannten Verantwortlichen.</p>
                 <p><strong class="text-slate-100">Anwendbares Recht und Gerichtsstand:</strong> Es gilt √∂sterreichisches Recht. Der Gerichtsstand ist Linz.</p>
             </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-sm m-4 modal-enter text-center">
            <p id="confirm-modal-text" class="text-slate-300 mb-6">Bist du sicher?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-6 rounded-lg transition">Abbrechen</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-6 rounded-lg transition">Best√§tigen</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, updateDoc, deleteDoc, query, where, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Config and Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyAm62EYO-knD48Gv_8h4asS_DsdiCVYhAo",
            authDomain: "spielrunde2.firebaseapp.com",
            projectId: "spielrunde2",
            storageBucket: "spielrunde2.appspot.com",
            messagingSenderId: "718528869080",
            appId: "1:718528869080:web:28fdf441af5187c0725dad",
            measurementId: "G-1HPY49Q9DK"
        };
        let db, auth;
        let currentUser = null;
        let verificationCheckInterval = null;
        let initialSharedQuestId = null;
        let allQuests = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 50;
        let sortConfig = { key: 'dateTime', direction: 'asc' };

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            const urlParams = new URLSearchParams(window.location.search);
            initialSharedQuestId = urlParams.get('quest');
        } catch (e) { console.error("Error initializing Firebase: ", e); }

        // --- DOM Elements ---
        const gameListCards = document.getElementById('game-list-cards');
        const authModal = document.getElementById('auth-modal');
        const nameFilterInput = document.getElementById('name-filter');
        const dayFilterContainer = document.getElementById('day-filter-container');
        const locationFilterContainer = document.getElementById('location-filter-container');
        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const sharedQuestModal = document.getElementById('shared-quest-modal');
        const locationFilterInput = document.getElementById('location-filter');
        const dateFilterInput = document.getElementById('date-filter');
        const clearDateFilterBtn = document.getElementById('clear-date-filter');
        const paginationControls = document.getElementById('pagination-controls');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const addGameBtn = document.getElementById('add-game-btn');
        const verificationBanner = document.getElementById('verification-banner');
        const addEditGameForm = document.getElementById('add-edit-game-form');
        const locationTypeSelect = document.getElementById('location-type');
        const customLocationContainer = document.getElementById('custom-location-container');
        const sideMenuContent = document.getElementById('side-menu-content');
        const sharedQuestContent = document.getElementById('shared-quest-content');
        const addEditGameModal = document.getElementById('add-edit-game-modal');
        const accountModal = document.getElementById('account-modal');
        const imprintModal = document.getElementById('imprint-modal');
        const privacyModal = document.getElementById('privacy-modal');
        const questListContainer = document.getElementById('quest-list-container');
        const confirmModal = document.getElementById('confirm-modal');
        
       
        // --- Helper Functions ---
        const showModal = (modal) => modal.classList.remove('hidden');
        const hideModal = (modal) => modal.classList.add('hidden');
        const openMenu = () => { sideMenu.classList.remove('translate-x-full'); menuOverlay.classList.remove('hidden'); };
        const closeMenu = () => { sideMenu.classList.add('translate-x-full'); menuOverlay.classList.add('hidden'); };

        // XSS Protection: Escape user-generated content before rendering
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, match => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[match]));
        }

        // Custom Toast Notification
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast toast-enter';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-leave');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        // Custom Confirmation Modal
        let confirmCallback = null;
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirm-modal-text').textContent = message;
            confirmCallback = onConfirm;
            showModal(confirmModal);
        }
        document.getElementById('confirm-modal-confirm-btn').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
            hideModal(confirmModal);
        });
        document.getElementById('confirm-modal-cancel-btn').addEventListener('click', () => hideModal(confirmModal));
        confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) hideModal(confirmModal); });

       
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Link in die Zwischenablage kopiert!');
            }).catch(err => {
                console.error('Fehler beim Kopieren:', err);
                showToast('Kopieren fehlgeschlagen.');
            });
        }

        // --- Event Delegation for dynamic content ---
        questListContainer.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-game-btn');
            const shareBtn = e.target.closest('.share-quest-btn');
            const joinLeaveBtn = e.target.closest('.join-leave-btn');
            const cancelBtn = e.target.closest('.cancel-game-btn');
            const viewBtn = e.target.closest('.view-quest-btn'); 

            if (editBtn) {
                const gameId = editBtn.dataset.gameId;
                const gameRef = doc(db, "spielrunden", gameId);
                const docSnap = await getDoc(gameRef);
                if (docSnap.exists()) {
                    openEditModal(docSnap);
                }
            } else if (shareBtn) {
                 const gameId = shareBtn.dataset.gameId;
                 const shareUrl = `${window.location.origin}${window.location.pathname}?quest=${gameId}`;
                 copyToClipboard(shareUrl);
            } else if (joinLeaveBtn) {
                if (!currentUser) { showModal(authModal); return; }
                const gameId = joinLeaveBtn.dataset.gameId;
                joinLeaveBtn.disabled = true;
                const gameRef = doc(db, "spielrunden", gameId);
                try {
                    const docSnap = await getDoc(gameRef);
                    if (docSnap.exists()) {
                        const gameData = docSnap.data();
                        const isParticipant = gameData.participants.some(p => p.uid === currentUser.uid);
                        let newParticipants;
                        if (isParticipant) {
                            newParticipants = gameData.participants.filter(p => p.uid !== currentUser.uid);
                        } else {
                            if (gameData.participants.length < gameData.totalSeats) {
                                newParticipants = [...gameData.participants, { uid: currentUser.uid, displayName: currentUser.displayName }];
                            } else {
                                showToast("Diese Runde ist bereits voll.");
                                joinLeaveBtn.disabled = false;
                                return;
                            }
                        }
                        await updateDoc(gameRef, { participants: newParticipants });
                    }
                } catch (error) { console.error("Fehler beim Beitreten/Verlassen:", error); } 
                finally { joinLeaveBtn.disabled = false; }
            } else if (cancelBtn) {
                const gameId = cancelBtn.dataset.gameId;
                showConfirmModal('Bist du sicher, dass du dieses Quest absagen m√∂chtest?', async () => {
                    const gameRef = doc(db, "spielrunden", gameId);
                    await updateDoc(gameRef, { cancelled: true });
                });
            } else if (viewBtn) {
                 const gameId = viewBtn.dataset.gameId;
                 const gameRef = doc(db, "spielrunden", gameId);
                 const docSnap = await getDoc(gameRef);
                 if (docSnap.exists()) {
                     renderSharedQuestModal(docSnap.data(), docSnap.id);
                     showModal(sharedQuestModal);
                 }
            }
        });

        // --- Event Listeners ---
        menuToggleBtn.addEventListener('click', openMenu);
        menuOverlay.addEventListener('click', closeMenu);
        addGameBtn.addEventListener('click', () => {
             if (!currentUser) { showModal(authModal); return; }
             const modalTitle = document.getElementById('modal-title');
             const submitBtn = document.getElementById('submit-btn');
             modalTitle.textContent = 'Neues Quest erstellen';
             submitBtn.textContent = 'Erstellen';
             addEditGameForm.reset();
             document.getElementById('edit-game-id').value = '';
             document.getElementById('delete-game-btn').classList.add('hidden');
             document.getElementById('reactivate-game-btn').classList.add('hidden');
             const maxDate = new Date();
             maxDate.setMonth(maxDate.getMonth() + 3);
             document.getElementById('game-date').setAttribute('max', maxDate.toISOString().split('T')[0]);
             showModal(addEditGameModal);
        });

        document.getElementById('cancel-add-game').addEventListener('click', () => hideModal(addEditGameModal));
        document.getElementById('close-auth-modal').addEventListener('click', () => hideModal(authModal));
        document.getElementById('close-account-modal').addEventListener('click', () => hideModal(accountModal));
        document.getElementById('close-imprint-modal').addEventListener('click', () => hideModal(imprintModal));
        document.getElementById('close-privacy-modal').addEventListener('click', () => hideModal(privacyModal));
        document.getElementById('imprint-link').addEventListener('click', (e) => { e.preventDefault(); showModal(imprintModal); });
        document.getElementById('privacy-link').addEventListener('click', (e) => { e.preventDefault(); showModal(privacyModal); });

        document.getElementById('delete-game-btn').addEventListener('click', async () => {
            const gameId = document.getElementById('edit-game-id').value;
            if (gameId) {
                showConfirmModal('Bist du sicher, dass du dieses Quest endg√ºltig l√∂schen m√∂chtest? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.', async () => {
                    const gameRef = doc(db, "spielrunden", gameId);
                    try {
                        await deleteDoc(gameRef);
                        hideModal(addEditGameModal);
                        showToast("Quest gel√∂scht.");
                    } catch (error) {
                        console.error("Fehler beim L√∂schen des Quests:", error);
                        showToast("Das Quest konnte nicht gel√∂scht werden.");
                    }
                });
            }
        });

        document.getElementById('reactivate-game-btn').addEventListener('click', async () => {
            const gameId = document.getElementById('edit-game-id').value;
            if (gameId) {
                const gameRef = doc(db, "spielrunden", gameId);
                await updateDoc(gameRef, { cancelled: false });
                hideModal(addEditGameModal);
                showToast("Quest wurde reaktiviert.");
            }
        });
       
        document.getElementById('resend-verification-btn').addEventListener('click', async (e) => {
            const btn = e.target;
            const feedback = document.getElementById('resend-feedback');
            btn.disabled = true;
            feedback.textContent = '';
            try {
                await sendEmailVerification(auth.currentUser);
                feedback.textContent = 'Erneut gesendet!';
                setTimeout(() => { feedback.textContent = ''; btn.disabled = false; }, 5000);
            } catch (error) {
                console.error("Error resending verification email:", error);
                feedback.textContent = 'Fehler.';
                 setTimeout(() => { feedback.textContent = ''; btn.disabled = false; }, 5000);
            }
        });

        document.getElementById('deletion-request-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('request-deletion-btn');
            const feedbackEl = document.getElementById('deletion-feedback');
            btn.disabled = true;
            feedbackEl.textContent = 'Sende Anfrage...';
            const formData = new FormData();
            formData.append('uid', currentUser.uid);
            formData.append('email', currentUser.email);
            formData.append('displayName', currentUser.displayName);
            formData.append('_subject', `L√∂schanfrage: ${currentUser.displayName}`);
            try {
                const response = await fetch("https://formspree.io/f/myzdgawa", {
                    method: 'POST', body: formData, headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error('Formspree submission failed');
                feedbackEl.textContent = 'L√∂schanfrage wurde gesendet.';
            } catch (error) {
                console.error("Error requesting deletion via Formspree:", error);
                feedbackEl.textContent = 'Fehler beim Senden der Anfrage.';
                btn.disabled = false;
            }
        });


        // Auth Modal Logic
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                document.querySelectorAll('.auth-tab').forEach(t => {
                    t.classList.remove('border-cyan-500', 'text-white');
                    t.classList.add('border-transparent', 'text-slate-400');
                });
                tab.classList.add('border-cyan-500', 'text-white');
                tab.classList.remove('border-transparent', 'text-slate-400');
               
                loginForm.classList.toggle('hidden', targetTab !== 'login');
                registerForm.classList.toggle('hidden', targetTab !== 'register');
                authError.textContent = '';
            });
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginButton = loginForm.querySelector('button[type="submit"]');
            authError.textContent = '';
            loginButton.disabled = true;
            loginButton.textContent = 'Logge ein...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login-Fehler:", error.code);
                authError.textContent = getGermanAuthError(error.code);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Einloggen';
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            authError.textContent = '';

            if (password !== passwordConfirm) {
                authError.textContent = 'Die Passw√∂rter stimmen nicht √ºberein.'; return;
            }
            if(name.length < 3) {
                 authError.textContent = 'Dein Anzeigename muss mindestens 3 Zeichen lang sein.'; return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                await sendEmailVerification(userCredential.user);
                showToast('Registrierung erfolgreich! Bitte E-Mail best√§tigen.');
            } catch (error) {
                console.error("Registrierungsfehler:", error.code);
                authError.textContent = getGermanAuthError(error.code);
            }
        });
       
        document.getElementById('forgot-password-link').addEventListener('click', async (e) => {
             e.preventDefault();
             const email = document.getElementById('login-email').value;
             if (!email) {
                 authError.textContent = 'Bitte gib deine E-Mail-Adresse ein.'; return;
             }
             try {
                 await sendPasswordResetEmail(auth, email);
                 authError.textContent = 'E-Mail zum Zur√ºcksetzen des Passworts wurde gesendet.';
             } catch (error) { authError.textContent = getGermanAuthError(error.code); }
        });

        function getGermanAuthError(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'E-Mail oder Passwort ist ung√ºltig.';
                case 'auth/email-already-in-use': return 'Diese E-Mail-Adresse wird bereits verwendet.';
                case 'auth/weak-password': return 'Das Passwort muss mindestens 6 Zeichen lang sein.';
                case 'auth/invalid-email': return 'Bitte gib eine g√ºltige E-Mail-Adresse ein.';
                default: return 'Ein unerwarteter Fehler ist aufgetreten.';
            }
        }

        locationTypeSelect.addEventListener('change', () => {
            customLocationContainer.classList.toggle('hidden', locationTypeSelect.value !== 'other');
        });

        addEditGameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { showToast("Bitte zuerst einloggen."); return; }
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Speichere...';

            try {
                const gameId = document.getElementById('edit-game-id').value;
                const locationType = document.getElementById('location-type').value;
                const location = locationType === 'other' ? document.getElementById('custom-location').value.trim() : locationType;
                const date = document.getElementById('game-date').value;
                const time = document.getElementById('game-time').value;
                const dateTime = new Date(`${date}T${time}`);
               
                if (!location) throw new Error("Der Spielort darf nicht leer sein.");
                if (isNaN(dateTime.getTime())) throw new Error("Ung√ºltiges Datum oder Uhrzeit.");

                const selectedTags = Array.from(document.querySelectorAll('#tags-container input:checked')).map(cb => cb.value);
                const questData = {
                    gameName: document.getElementById('game-name').value.trim(),
                    location: location,
                    dateTime: Timestamp.fromDate(dateTime),
                    totalSeats: parseInt(document.getElementById('total-seats').value, 10),
                    duration: parseInt(document.getElementById('game-duration').value, 10) || null,
                    tags: selectedTags,
                };

                if (gameId) {
                    const gameRef = doc(db, "spielrunden", gameId);
                    const docSnap = await getDoc(gameRef);
                    if (docSnap.exists()) {
                        const existingData = docSnap.data();
                        let participants = existingData.participants;
                        const organizerParticipates = document.getElementById('organizer-participates').checked;
                        const isOrganizerInList = participants.some(p => p.uid === currentUser.uid);
                        if (organizerParticipates && !isOrganizerInList) {
                            participants.push({ uid: currentUser.uid, displayName: currentUser.displayName });
                        } else if (!organizerParticipates && isOrganizerInList) {
                            participants = participants.filter(p => p.uid !== currentUser.uid);
                        }
                        questData.participants = participants;
                        await updateDoc(gameRef, questData);
                    }
                } else {
                    questData.creatorId = currentUser.uid;
                    questData.creatorName = currentUser.displayName;
                    questData.createdAt = Timestamp.now();
                    questData.cancelled = false;
                    questData.participants = [];
                   
                    if (document.getElementById('organizer-participates').checked) {
                        questData.participants.push({ uid: currentUser.uid, displayName: currentUser.displayName });
                    }
                    await addDoc(collection(db, "spielrunden"), questData);
                }
                hideModal(addEditGameModal);
            } catch (error) {
                console.error("Fehler beim Speichern des Quests:", error);
                showToast(`Fehler: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
            }
        });
       
        function applyAllTransformsAndRender() {
            const selectedDate = dateFilterInput.value;
            const selectedDays = Array.from(dayFilterContainer.querySelectorAll('.day-filter-btn.active')).map(btn => btn.dataset.day);
            const selectedLocations = Array.from(locationFilterContainer.querySelectorAll('.location-filter-btn.active')).map(btn => btn.dataset.location);
            const nameText = nameFilterInput.value.toLowerCase().trim();
            const locationText = locationFilterInput ? locationFilterInput.value.toLowerCase().trim() : "";

            const filteredQuests = allQuests.filter(quest => {
                const questDate = quest.dateTime.toDate();
                const questDateString = questDate.toISOString().slice(0, 10);
                const cardDay = questDate.getDay().toString();
                const cardLocation = quest.location;
                const cardLocationLower = cardLocation.toLowerCase();
                const cardName = quest.gameName.toLowerCase();
                const dateMatch = !selectedDate || questDateString === selectedDate;
                const dayMatch = selectedDays.includes('all') || selectedDays.length === 0 || selectedDays.includes(cardDay);
                const locationButtonMatch = selectedLocations.includes('all') || selectedLocations.length === 0 || selectedLocations.includes(cardLocation);
                const locationTextMatch = locationText === '' || cardLocationLower.includes(locationText);
                const nameMatch = (nameText === '' || cardName.includes(nameText));

                if (selectedDate) return dateMatch && locationButtonMatch && locationTextMatch && nameMatch;
                return dayMatch && locationButtonMatch && locationTextMatch && nameMatch;
            });

            filteredQuests.sort((a, b) => {
                const valA = a[sortConfig.key].toMillis();
                const valB = b[sortConfig.key].toMillis();
                return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
            });
           
            const totalPages = Math.ceil(filteredQuests.length / ITEMS_PER_PAGE);
            if (currentPage > totalPages) currentPage = totalPages || 1;
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedQuests = filteredQuests.slice(start, end);

            renderQuestLists(paginatedQuests);
            renderPaginationControls(totalPages);
        }

        function renderQuestLists(quests) {
            gameListCards.innerHTML = '';
            const selectedDate = dateFilterInput.value;

            if (quests.length === 0) {
                const message = allQuests.length > 0 ? 'Keine Quests f√ºr diese Filter gefunden.' : 'Aktuell sind keine Quests verf√ºgbar. Erstelle das erste!';
                gameListCards.innerHTML = `<div class="col-span-full text-slate-400 text-center">${message}</div>`;
                return;
            }

            if (selectedDate) {
                const dateObj = new Date(selectedDate);
                const timezoneOffset = dateObj.getTimezoneOffset() * 60000;
                const adjustedDate = new Date(dateObj.getTime() + timezoneOffset);
                const heading = document.createElement('h3');
                heading.className = 'text-lg font-semibold text-slate-400 mt-6 mb-3 col-span-full';
                heading.textContent = `Quests am ${adjustedDate.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' })}`;
                gameListCards.appendChild(heading);
                quests.forEach(quest => gameListCards.appendChild(renderGameCard({ id: quest.id, data: () => quest })));
                return;
            }

            const questsByDay = quests.reduce((acc, quest) => {
                const date = quest.dateTime.toDate();
                const sortableKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                if (!acc[sortableKey]) acc[sortableKey] = { dateObj: date, quests: [] };
                acc[sortableKey].quests.push(quest);
                return acc;
            }, {});
            
            Object.keys(questsByDay).sort().forEach(dayKey => {
                const { dateObj, quests } = questsByDay[dayKey];
                const heading = document.createElement('h3');
                heading.className = 'text-lg font-semibold text-slate-400 mt-6 mb-3 col-span-full';
                heading.textContent = dateObj.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
                gameListCards.appendChild(heading);
                quests.forEach(quest => gameListCards.appendChild(renderGameCard({ id: quest.id, data: () => quest })));
            });
        }
       
        function renderPaginationControls(totalPages) {
            paginationControls.innerHTML = '';
            if (totalPages > 1) {
                const prevDisabled = currentPage === 1 ? 'disabled' : '';
                const nextDisabled = currentPage === totalPages ? 'disabled' : '';
                paginationControls.innerHTML = `
                    <button id="prev-page-btn" class="px-3 py-1 bg-slate-700 rounded-md disabled:opacity-50" ${prevDisabled}>&lt; Zur√ºck</button>
                    <span>Seite ${currentPage} von ${totalPages}</span>
                    <button id="next-page-btn" class="px-3 py-1 bg-slate-700 rounded-md disabled:opacity-50" ${nextDisabled}>Weiter &gt;</button>
                `;
                 document.getElementById('prev-page-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; applyAllTransformsAndRender(); } });
                 document.getElementById('next-page-btn').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; applyAllTransformsAndRender(); } });
            }
        }
        
        dayFilterContainer.addEventListener('click', (e) => { 
            if (e.target.classList.contains('day-filter-btn')) { 
                dateFilterInput.value = '';
                clearDateFilterBtn.classList.add('hidden');
                const clickedDay = e.target.dataset.day; 
                if (clickedDay === 'all') { 
                    dayFilterContainer.querySelectorAll('.day-filter-btn').forEach(btn => btn.classList.remove('active')); 
                    e.target.classList.add('active'); 
                } else { 
                    dayFilterContainer.querySelector('[data-day="all"]').classList.remove('active'); 
                    e.target.classList.toggle('active'); 
                    if (dayFilterContainer.querySelectorAll('.day-filter-btn.active').length === 0) { 
                        dayFilterContainer.querySelector('[data-day="all"]').classList.add('active'); 
                    } 
                } 
                applyAllTransformsAndRender(); 
            } 
        });
        locationFilterContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('location-filter-btn')) {
                const clickedLocation = e.target.dataset.location;
                if (clickedLocation === 'all') {
                    locationFilterContainer.querySelectorAll('.location-filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                } else {
                    locationFilterContainer.querySelector('[data-location="all"]').classList.remove('active');
                    e.target.classList.toggle('active');
                    if (locationFilterContainer.querySelectorAll('.location-filter-btn.active').length === 0) {
                        locationFilterContainer.querySelector('[data-location="all"]').classList.add('active');
                    }
                }
                applyAllTransformsAndRender();
            }
        });
        nameFilterInput.addEventListener('input', applyAllTransformsAndRender);
        if (locationFilterInput) locationFilterInput.addEventListener('input', applyAllTransformsAndRender);
        dateFilterInput.addEventListener('change', () => {
            dayFilterContainer.querySelectorAll('.day-filter-btn').forEach(btn => btn.classList.remove('active'));
            dayFilterContainer.querySelector('[data-day="all"]').classList.add('active');
            clearDateFilterBtn.classList.toggle('hidden', !dateFilterInput.value);
            applyAllTransformsAndRender();
        });
        clearDateFilterBtn.addEventListener('click', () => {
            dateFilterInput.value = '';
            clearDateFilterBtn.classList.add('hidden');
            applyAllTransformsAndRender();
        });


        onAuthStateChanged(auth, async (user) => {
            if (verificationCheckInterval) clearInterval(verificationCheckInterval);
            const wasJustLoggedIn = !currentUser && user;
            currentUser = user ? { uid: user.uid, displayName: user.displayName, email: user.email, emailVerified: user.emailVerified } : null;
           
            if (wasJustLoggedIn) hideModal(authModal);
            
            updateUserUI(!!user);
            updateSideMenu(!!user);
            listenToGames(); 

            if (initialSharedQuestId) {
                const questId = initialSharedQuestId;
                initialSharedQuestId = null; 
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.delete('quest');
                window.history.replaceState({}, document.title, newUrl.href);
                const questRef = doc(db, "spielrunden", questId);
                try {
                    const docSnap = await getDoc(questRef);
                    if (docSnap.exists()) {
                        renderSharedQuestModal(docSnap.data(), docSnap.id);
                        showModal(sharedQuestModal);
                    }
                } catch (error) { console.error("Error fetching shared quest:", error); }
            } else if (wasJustLoggedIn && !sharedQuestModal.classList.contains('hidden')) {
                const questId = sharedQuestContent.dataset.questId;
                if (questId) {
                    const questRef = doc(db, "spielrunden", questId);
                    const docSnap = await getDoc(questRef);
                    if (docSnap.exists()) renderSharedQuestModal(docSnap.data(), docSnap.id);
                }
            }

            if (user && !user.emailVerified) {
                verificationBanner.classList.remove('hidden');
                verificationCheckInterval = setInterval(async () => {
                    await auth.currentUser.reload();
                    if (auth.currentUser.emailVerified) {
                        clearInterval(verificationCheckInterval);
                        showToast("E-Mail erfolgreich best√§tigt. Bitte neu einloggen.");
                        signOut(auth);
                    }
                }, 5000);
            }
        });

        function updateUserUI(isLoggedIn) {
            verificationBanner.classList.add('hidden');
            if (isLoggedIn && !currentUser.emailVerified) {
                verificationBanner.classList.remove('hidden');
            }
        }
       
        function updateSideMenu(isLoggedIn) {
            let menuHTML = `<button id="close-menu-btn" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>`;
            if (isLoggedIn) {
                menuHTML += `
                    <div class="mb-6">
                        <p class="font-semibold text-white">${escapeHTML(currentUser.displayName || '')}</p>
                        <p class="text-sm text-slate-400">${escapeHTML(currentUser.email)}</p>
                    </div>
                    <nav class="flex flex-col space-y-2">
                        <a href="#" id="account-btn" class="p-2 rounded-md hover:bg-slate-700">Mein Konto</a>
                        <a href="anleitung.html" class="p-2 rounded-md hover:bg-slate-700">Anleitung</a>
                        <a href="faq.html" class="p-2 rounded-md hover:bg-slate-700">FAQ</a>
                        <div class="border-t border-slate-700 my-2"></div>
                        <a href="#" id="imprint-menu-link" class="p-2 rounded-md hover:bg-slate-700 text-sm">Impressum</a>
                        <a href="#" id="privacy-menu-link" class="p-2 rounded-md hover:bg-slate-700 text-sm">Datenschutz</a>
                        <a href="#" id="logout-btn" class="p-2 rounded-md hover:bg-slate-700 border-t border-slate-700 mt-2 pt-3">Ausloggen</a>
                    </nav>
                `;
            } else {
                menuHTML += `
                     <h2 class="text-xl font-bold mb-6">Men√º</h2>
                     <nav class="flex flex-col space-y-2">
                         <a href="#" id="login-register-btn" class="p-2 rounded-md hover:bg-slate-700">Login / Registrieren</a>
                         <a href="anleitung.html" class="p-2 rounded-md hover:bg-slate-700">Anleitung</a>
                         <a href="faq.html" class="p-2 rounded-md hover:bg-slate-700">FAQ</a>
                         <div class="border-t border-slate-700 my-2"></div>
                         <a href="#" id="imprint-menu-link" class="p-2 rounded-md hover:bg-slate-700 text-sm">Impressum</a>
                         <a href="#" id="privacy-menu-link" class="p-2 rounded-md hover:bg-slate-700 text-sm">Datenschutz</a>
                    </nav>
                `;
            }
            sideMenuContent.innerHTML = menuHTML;

            document.getElementById('close-menu-btn').addEventListener('click', closeMenu);
            const handleMenuLinkClick = (id, modal) => {
                sideMenuContent.querySelector(id)?.addEventListener('click', (e) => { e.preventDefault(); showModal(modal); closeMenu(); });
            };
            handleMenuLinkClick('#imprint-menu-link', imprintModal);
            handleMenuLinkClick('#privacy-menu-link', privacyModal);

            if(isLoggedIn) {
                sideMenuContent.querySelector('#logout-btn').addEventListener('click', (e) => { e.preventDefault(); signOut(auth); closeMenu(); });
                sideMenuContent.querySelector('#account-btn').addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    document.getElementById('account-name').textContent = currentUser.displayName; 
                    document.getElementById('account-email').textContent = currentUser.email;
                    document.getElementById('request-deletion-btn').disabled = false;
                    document.getElementById('deletion-feedback').textContent = '';
                    showModal(accountModal); 
                    closeMenu(); 
                });
            } else {
                sideMenuContent.querySelector('#login-register-btn').addEventListener('click', (e) => { e.preventDefault(); showModal(authModal); closeMenu(); });
            }
        }
       
        let unsubscribeFromGames = null;
        function listenToGames() { 
            if (unsubscribeFromGames) unsubscribeFromGames(); 
            const cutoffDate = new Date(new Date().getTime() - 3 * 60 * 60 * 1000);
            const q = query(collection(db, "spielrunden"), where("dateTime", ">=", Timestamp.fromDate(cutoffDate)), orderBy("dateTime", "asc")); 
            
            unsubscribeFromGames = onSnapshot(q, (snapshot) => { 
                loadingIndicator.style.display = 'none';
                allQuests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyAllTransformsAndRender();
            }, (error) => { 
                console.error("Firestore Error:", error); 
                loadingIndicator.innerHTML = '<p class="text-red-400 text-center col-span-full">Fehler beim Laden der Quests.</p>'; 
            }); 
        }
       
        function renderGameCard(doc) {
            const game = doc.data(); 
            const gameId = doc.id;
            const isCreator = currentUser?.uid === game.creatorId; 
            const isParticipant = currentUser && game.participants.some(p => p.uid === currentUser.uid); 
            const participantsCount = game.participants.length; 
            const isFull = participantsCount >= game.totalSeats; 
            const isCancelled = game.cancelled || false; 
            const gameDate = game.dateTime.toDate(); 
            const formattedDate = gameDate.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' }); 
            const formattedTime = gameDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }); 
           
            const card = document.createElement('div');
            card.className = `quest-card view-quest-btn bg-slate-800 rounded-lg shadow-lg p-6 flex flex-col relative transition-transform transform hover:scale-105 cursor-pointer`; 
            card.dataset.gameId = gameId;
           
            let tagsHTML = (game.tags || []).map(tag => `<span class="bg-cyan-800 text-cyan-200 text-xs font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full">${escapeHTML(tag)}</span>`).join(''); 

            card.innerHTML = `
                ${isCancelled ? '<div class="absolute inset-0 bg-red-900/70 flex items-center justify-center rounded-lg z-10"><span class="text-2xl font-bold text-white transform -rotate-12">ABGESAGT</span></div>' : ''}
                <div class="flex-grow ${isCancelled ? 'opacity-50' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-cyan-400 pr-12">${escapeHTML(game.gameName)}</h3>
                        <div class="absolute top-4 right-4 flex items-center gap-2 text-xl z-20">
                            <button class="share-quest-btn text-slate-500 hover:text-cyan-400" title="Quest teilen" data-game-id="${gameId}">üîó</button>
                            ${isCreator ? `
                                <button class="edit-game-btn text-slate-500 hover:text-cyan-400" title="${isCancelled ? 'Verwalten' : 'Bearbeiten'}" data-game-id="${gameId}">‚úèÔ∏è</button>
                                ${!isCancelled ? `<button class="cancel-game-btn text-slate-500 hover:text-red-400" title="Absagen" data-game-id="${gameId}">‚®∑</button>` : ''}
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex items-center text-slate-400 mb-3 text-sm">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        <span>${escapeHTML(game.location)}</span>
                    </div>
                     <div class="flex items-center text-slate-300 mb-4 text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z"></path></svg>
                        <span>${formattedDate}, ${formattedTime} Uhr ${game.duration ? `(ca. ${game.duration} Min.)` : ''}</span>
                    </div>
                    <div class="flex flex-wrap mb-4">${tagsHTML}</div>
                </div>
                <div class="border-t border-slate-700 pt-4 mt-auto ${isCancelled ? 'opacity-50' : ''}">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center text-slate-300">
                                 <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 1 1 0 5.292M15 21H3v-1a6 6 0 0 1 12 0v1Zm0 0h6v-1a6 6 0 0 0-9-5.197M15 21a6 6 0 0 0-9-5.197m0 0A5.995 5.995 0 0 0 12 12a5.995 5.995 0 0 0-3-5.197M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path></svg>
                                 <span class="${isFull ? 'text-red-400' : 'text-green-400'} font-semibold">${participantsCount}/${game.totalSeats}</span>
                            </div>
                            <div class="flex -space-x-2 overflow-hidden">
                                 ${game.participants.slice(0, 3).map(p => `<span class="inline-block h-6 w-6 rounded-full bg-slate-600 ring-2 ring-slate-800 text-center leading-6 text-[10px]" title="${escapeHTML(p.displayName)}">${escapeHTML(p.displayName).substring(0, 2).toUpperCase()}</span>`).join('')}
                                 ${game.participants.length > 3 ? `<span class="flex items-center justify-center h-6 w-6 rounded-full bg-slate-700 ring-2 ring-slate-800 text-[10px] font-medium text-slate-400">+${game.participants.length - 3}</span>` : ''}
                            </div>
                        </div>
                        <div>
                            <button class="join-leave-btn font-semibold py-2 px-4 rounded-lg transition text-sm ${isCancelled ? 'bg-slate-700 text-slate-500' : (isParticipant ? 'bg-amber-600 hover:bg-amber-700' : (isFull && !isParticipant ? 'bg-slate-700 text-slate-500' : 'bg-cyan-500 hover:bg-cyan-600'))}" data-game-id="${gameId}" ${isCancelled || (isFull && !isParticipant) ? 'disabled' : ''}>
                                ${isCancelled ? 'Abgesagt' : (isParticipant ? 'Verlassen' : (isFull ? 'Voll' : 'Dabei!'))}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        function openEditModal(doc) {
            const game = doc.data();
            addEditGameForm.reset();
            document.getElementById('edit-game-id').value = doc.id;
            document.getElementById('game-name').value = game.gameName;

            const locationSelect = document.getElementById('location-type');
            const customLocationInput = document.getElementById('custom-location');
            const isPredefinedLocation = Array.from(locationSelect.options).some(opt => opt.value === game.location);
            if (isPredefinedLocation) {
                locationSelect.value = game.location;
                customLocationContainer.classList.add('hidden');
            } else {
                locationSelect.value = 'other';
                customLocationContainer.classList.remove('hidden');
                customLocationInput.value = game.location;
            }

            const gameDate = game.dateTime.toDate();
            document.getElementById('game-date').value = `${gameDate.getFullYear()}-${String(gameDate.getMonth() + 1).padStart(2, '0')}-${String(gameDate.getDate()).padStart(2, '0')}`;
            document.getElementById('game-time').value = gameDate.toTimeString().slice(0, 5);
            document.getElementById('total-seats').value = game.totalSeats;
            document.getElementById('game-duration').value = game.duration || '';
            document.querySelectorAll('#tags-container input[type="checkbox"]').forEach(cb => {
                cb.checked = game.tags?.includes(cb.value);
            });
            document.getElementById('organizer-participates').checked = game.participants.some(p => p.uid === game.creatorId);

            const isCancelled = game.cancelled || false;
            document.querySelectorAll('#add-edit-game-form *:not(button)').forEach(el => el.disabled = isCancelled);
            document.getElementById('submit-btn').disabled = isCancelled;
            document.getElementById('modal-title').textContent = isCancelled ? 'Quest reaktivieren' : 'Quest bearbeiten';
            document.getElementById('delete-game-btn').classList.toggle('hidden', isCancelled);
            document.getElementById('reactivate-game-btn').classList.toggle('hidden', !isCancelled);
            
            showModal(addEditGameModal);
        }

        function renderSharedQuestModal(game, gameId) {
            const isCreator = currentUser?.uid === game.creatorId;
            const isParticipant = currentUser && game.participants.some(p => p.uid === currentUser.uid);
            const participantsCount = game.participants.length;
            const isFull = participantsCount >= game.totalSeats;
            const isCancelled = game.cancelled || false;
            const gameDate = game.dateTime.toDate();
            const formattedDate = gameDate.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
            const formattedTime = gameDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            let participantsHTML = game.participants.map(p => `
                 <span class="bg-slate-700 text-slate-300 text-sm font-medium pl-2.5 pr-1.5 py-1 rounded-full flex items-center gap-1">
                     ${escapeHTML(p.displayName)}
                     ${isCreator && currentUser?.uid !== p.uid ? `<button class="remove-participant-btn text-red-400 hover:text-red-200" data-game-id="${gameId}" data-participant-uid="${p.uid}" title="Teilnehmer entfernen">&times;</button>` : ''}
                 </span>`).join('') || '<p class="text-slate-500 text-sm">Noch keine Teilnehmer.</p>';
            let tagsHTML = (game.tags || []).map(tag => `<span class="bg-cyan-800 text-cyan-200 text-xs font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full">${escapeHTML(tag)}</span>`).join('');

            sharedQuestContent.dataset.questId = gameId;
            sharedQuestContent.innerHTML = `
                <button id="close-shared-quest-modal" class="absolute top-4 right-4 text-slate-500 hover:text-white text-2xl">&times;</button>
                <h3 class="text-3xl font-bold text-cyan-400 mb-2">${escapeHTML(game.gameName)}</h3>
                <p class="text-slate-400 mb-4">Organisiert von <span class="font-semibold">${escapeHTML(game.creatorName)}</span></p>
                <div class="space-y-4 mb-6">
                    <div class="flex items-center text-slate-300"><svg class="w-5 h-5 mr-3 text-slate-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg><span>${escapeHTML(game.location)}</span></div>
                    <div class="flex items-center text-slate-300"><svg class="w-5 h-5 mr-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z"></path></svg><span>${formattedDate} um ${formattedTime} Uhr</span></div>
                    ${game.duration ? `<div class="flex items-center text-slate-300"><svg class="w-5 h-5 mr-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path></svg><span>ca. ${game.duration} Minuten</span></div>` : ''}
                    <div class="flex items-center text-slate-300"><svg class="w-5 h-5 mr-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 1 1 0 5.292M15 21H3v-1a6 6 0 0 1 12 0v1Zm0 0h6v-1a6 6 0 0 0-9-5.197M15 21a6 6 0 0 0-9-5.197m0 0A5.995 5.995 0 0 0 12 12a5.995 5.995 0 0 0-3-5.197M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path></svg><span class="${isFull ? 'text-red-400' : 'text-green-400'} font-semibold">${isFull ? 'Runde ist voll' : `${game.totalSeats - participantsCount} von ${game.totalSeats} Pl√§tzen frei`}</span></div>
                </div>
                ${tagsHTML ? `<div class="flex flex-wrap mb-4">${tagsHTML}</div>` : ''}
                <div class="border-t border-slate-700 pt-4">
                    <h4 class="font-semibold text-slate-300 mb-2">Teilnehmer (${participantsCount}/${game.totalSeats}):</h4>
                    <div class="flex flex-wrap gap-2">${participantsHTML}</div>
                </div>
                ${isCreator ? `<div class="mt-4 text-center"><button id="edit-from-shared-modal-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition" data-game-id="${gameId}">${isCancelled ? 'Verwalten' : 'Bearbeiten'}</button></div>` : ''}
                <div class="mt-6">
                    <button class="join-leave-btn w-full font-bold py-3 px-4 rounded-lg transition ${isCancelled ? 'bg-slate-700 text-slate-500' : (isParticipant ? 'bg-amber-600 hover:bg-amber-700' : (isFull ? 'bg-slate-700 text-slate-500' : 'bg-cyan-500 hover:bg-cyan-600'))}" data-game-id="${gameId}" ${isCancelled || (isFull && !isParticipant) ? 'disabled' : ''}>${isCancelled ? 'Abgesagt' : (isParticipant ? 'Teilnahme zur√ºckziehen' : (isFull ? 'Voll' : 'An Quest teilnehmen'))}</button>
                </div>
            `;
        }

        sharedQuestModal.addEventListener('click', async (e) => {
            if (e.target.id === 'close-shared-quest-modal' || e.target === sharedQuestModal) {
                hideModal(sharedQuestModal); return;
            }
            const removeParticipantBtn = e.target.closest('.remove-participant-btn');
            const joinLeaveBtn = e.target.closest('.join-leave-btn');
            const editFromSharedBtn = e.target.closest('#edit-from-shared-modal-btn');

            if (editFromSharedBtn) {
                const gameId = editFromSharedBtn.dataset.gameId;
                const gameRef = doc(db, "spielrunden", gameId);
                const docSnap = await getDoc(gameRef);
                if (docSnap.exists()) { hideModal(sharedQuestModal); openEditModal(docSnap); }
                return;
            }
            
            if (removeParticipantBtn) {
                const gameId = removeParticipantBtn.dataset.gameId;
                const participantUid = removeParticipantBtn.dataset.participantUid;
                showConfirmModal('Bist du sicher, dass du diesen Teilnehmer entfernen m√∂chtest?', async () => {
                     const gameRef = doc(db, "spielrunden", gameId);
                     try {
                         const docSnap = await getDoc(gameRef);
                         if (docSnap.exists()) {
                             const newParticipants = docSnap.data().participants.filter(p => p.uid !== participantUid);
                             await updateDoc(gameRef, { participants: newParticipants });
                             renderSharedQuestModal( (await getDoc(gameRef)).data(), gameId );
                         }
                     } catch (error) { console.error("Fehler beim Entfernen:", error); showToast("Fehler beim Entfernen."); }
                });
            } else if (joinLeaveBtn) {
                if (!currentUser) { hideModal(sharedQuestModal); showModal(authModal); return; }
                const gameId = joinLeaveBtn.dataset.gameId;
                joinLeaveBtn.disabled = true;
                const gameRef = doc(db, "spielrunden", gameId);
                try {
                    const docSnap = await getDoc(gameRef);
                    if (docSnap.exists()) {
                        const gameData = docSnap.data();
                        const isParticipant = gameData.participants.some(p => p.uid === currentUser.uid);
                        let newParticipants;
                        if (isParticipant) {
                            newParticipants = gameData.participants.filter(p => p.uid !== currentUser.uid);
                        } else {
                            if (gameData.participants.length < gameData.totalSeats) {
                                newParticipants = [...gameData.participants, { uid: currentUser.uid, displayName: currentUser.displayName }];
                            } else {
                                showToast("Diese Runde ist bereits voll."); return;
                            }
                        }
                        await updateDoc(gameRef, { participants: newParticipants });
                        renderSharedQuestModal((await getDoc(gameRef)).data(), gameId);
                    }
                } catch (error) { console.error("Fehler beim Beitreten/Verlassen:", error); }
            }
        });

    </script>
</body>
</html>

