<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genduron Spiel-Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        .modal-leave { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">

    <!-- Header -->
    <header class="bg-slate-800/70 backdrop-blur-sm sticky top-0 z-20 shadow-lg">
        <div class="container mx-auto px-4 py-4 max-w-5xl">
            <h1 class="text-3xl font-bold text-cyan-400">üé≤ Genduron Spiel-Finder</h1>
            <p class="text-slate-400 mt-1">Finde schnell Mitspieler f√ºr eine Runde im LAST.</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 max-w-5xl">
        <!-- Action Button -->
        <div class="my-6 text-center">
            <button id="add-game-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                (+) Neue Spielrunde anbieten
            </button>
        </div>

        <!-- Game List -->
        <div id="game-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Loading indicator -->
             <div id="loading-indicator" class="text-center col-span-full py-10">
                <p class="text-slate-400 text-lg">Lade Spielrunden...</p>
            </div>
            <!-- Game cards will be inserted here by JavaScript -->
        </div>
    </main>

    <!-- Add Game Modal -->
    <div id="add-game-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-md m-4 modal-enter">
            <h2 class="text-2xl font-bold mb-6">Neue Spielrunde erstellen</h2>
            <form id="add-game-form">
                <div class="mb-4">
                    <label for="organizer-name" class="block text-slate-400 mb-2">Dein Name</label>
                    <input type="text" id="organizer-name" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                <div class="mb-4">
                    <label for="game-name" class="block text-slate-400 mb-2">Spiel</label>
                    <input type="text" id="game-name" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="game-date" class="block text-slate-400 mb-2">Datum</label>
                        <input type="date" id="game-date" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                    <div>
                        <label for="game-time" class="block text-slate-400 mb-2">Uhrzeit</label>
                        <input type="time" id="game-time" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="total-seats" class="block text-slate-400 mb-2">Pl√§tze insgesamt</label>
                    <input type="number" id="total-seats" min="1" max="20" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-game" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition">Abbrechen</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Erstellen</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Join Game Modal -->
    <div id="join-game-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl w-full max-w-sm m-4 modal-enter">
            <h2 class="text-2xl font-bold mb-6">Runde beitreten</h2>
            <form id="join-game-form">
                <div class="mb-6">
                    <label for="player-name" class="block text-slate-400 mb-2">Dein Name</label>
                    <input type="text" id="player-name" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-join-game" class="bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-lg transition">Abbrechen</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Ich bin dabei!</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, arrayUnion, query, where, Timestamp, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- USER PROVIDED FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDYc51kqFDkNXwjXcO-D4xkdhXvjR-QwU8",
            authDomain: "spielrunden-8c451.firebaseapp.com",
            projectId: "spielrunden-8c451",
            storageBucket: "spielrunden-8c451.firebasestorage.app",
            messagingSenderId: "938083491603",
            appId: "1:938083491603:web:e0667189e4b685ee5604e6",
            measurementId: "G-2S7NE5WSXS"
        };

        // --- FIREBASE INITIALIZATION ---
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Error initializing Firebase: ", e);
            document.getElementById('loading-indicator').innerText = 'Fehler bei der Verbindung zur Datenbank.';
        }
        
        // --- DOM ELEMENTS ---
        const addGameBtn = document.getElementById('add-game-btn');
        const addGameModal = document.getElementById('add-game-modal');
        const addGameForm = document.getElementById('add-game-form');
        const cancelAddGameBtn = document.getElementById('cancel-add-game');
        
        const joinGameModal = document.getElementById('join-game-modal');
        const joinGameForm = document.getElementById('join-game-form');
        const cancelJoinGameBtn = document.getElementById('cancel-join-game');
        
        const gameList = document.getElementById('game-list');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        let currentGameIdToJoin = null;

        // --- MODAL HANDLING ---
        function showModal(modal) {
            modal.classList.remove('hidden');
            modal.firstElementChild.classList.remove('modal-leave');
            modal.firstElementChild.classList.add('modal-enter');
        }

        function hideModal(modal) {
            modal.firstElementChild.classList.remove('modal-enter');
            modal.firstElementChild.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        addGameBtn.addEventListener('click', () => showModal(addGameModal));
        cancelAddGameBtn.addEventListener('click', () => hideModal(addGameModal));
        cancelJoinGameBtn.addEventListener('click', () => hideModal(joinGameModal));
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideModal(addGameModal);
                hideModal(joinGameModal);
            }
        });

        // --- RENDER GAME CARD ---
        function renderGame(doc) {
            const game = doc.data();
            const gameId = doc.id;
            const participantsCount = game.participants.length;
            const freeSeats = game.totalSeats - participantsCount;
            const isFull = freeSeats <= 0;

            const gameDate = game.dateTime.toDate();
            const isPast = gameDate < new Date();

            const formattedDate = gameDate.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
            const formattedTime = gameDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            const card = document.createElement('div');
            card.className = `bg-slate-800 rounded-lg shadow-lg p-6 flex flex-col transition-transform transform hover:-translate-y-1 ${isPast ? 'opacity-50' : ''}`;
            
            let participantsHTML = game.participants.map(p => `<span class="bg-slate-700 text-slate-300 text-sm font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full">${p}</span>`).join('');

            card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-2xl font-bold text-cyan-400 mb-2">${game.gameName}</h3>
                    <p class="text-slate-400 mb-4">von <span class="font-semibold">${game.organizerName}</span></p>
                    <div class="flex items-center text-slate-300 mb-4">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z"></path></svg>
                        <span>${formattedDate} um ${formattedTime} Uhr</span>
                    </div>
                    <div class="flex items-center text-slate-300 mb-6">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 1 1 0 5.292M15 21H3v-1a6 6 0 0 1 12 0v1Zm0 0h6v-1a6 6 0 0 0-9-5.197M15 21a6 6 0 0 0-9-5.197m0 0A5.995 5.995 0 0 0 12 12a5.995 5.995 0 0 0-3-5.197M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path></svg>
                        <span class="${isFull ? 'text-red-400' : 'text-green-400'} font-semibold">${freeSeats > 0 ? `${freeSeats} von ${game.totalSeats} Pl√§tzen frei` : 'Runde ist voll'}</span>
                    </div>
                    <h4 class="font-semibold text-slate-300 mb-2">Teilnehmer (${participantsCount}/${game.totalSeats}):</h4>
                    <div class="flex flex-wrap">${participantsHTML}</div>
                </div>
                <div class="mt-6">
                    <button class="join-btn w-full font-bold py-3 px-4 rounded-lg transition ${isFull || isPast ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-cyan-500 hover:bg-cyan-600'}" 
                            data-game-id="${gameId}" ${isFull || isPast ? 'disabled' : ''}>
                        ${isPast ? 'Vergangen' : (isFull ? 'Voll' : 'Ich bin dabei!')}
                    </button>
                </div>
            `;

            return card;
        }
        
        // --- FIRESTORE LOGIC ---
        if (db) {
            const gamesCol = collection(db, "spielrunden");
            const q = query(gamesCol, orderBy("dateTime", "asc"));

            onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                gameList.innerHTML = '';
                if (snapshot.empty) {
                     gameList.innerHTML = '<p class="text-slate-400 text-center col-span-full">Aktuell sind keine Spielrunden geplant. Biete doch eine an!</p>';
                } else {
                    snapshot.docs.forEach(doc => {
                        const card = renderGame(doc);
                        gameList.appendChild(card);
                    });
                }
            }, (error) => {
                console.error("Error fetching games: ", error);
                gameList.innerHTML = '<p class="text-red-400 text-center col-span-full">Fehler beim Laden der Spielrunden.</p>';
            });

            addGameForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const organizerName = addGameForm['organizer-name'].value.trim();
                const gameName = addGameForm['game-name'].value.trim();
                const gameDate = addGameForm['game-date'].value;
                const gameTime = addGameForm['game-time'].value;
                const totalSeats = parseInt(addGameForm['total-seats'].value);

                const dateTime = Timestamp.fromDate(new Date(`${gameDate}T${gameTime}`));

                try {
                    await addDoc(gamesCol, {
                        organizerName,
                        gameName,
                        dateTime,
                        totalSeats,
                        participants: [organizerName]
                    });
                    addGameForm.reset();
                    hideModal(addGameModal);
                } catch (error) {
                    console.error("Error adding document: ", error);
                }
            });

            gameList.addEventListener('click', (e) => {
                if (e.target.classList.contains('join-btn')) {
                    currentGameIdToJoin = e.target.dataset.gameId;
                    showModal(joinGameModal);
                    document.getElementById('player-name').focus();
                }
            });

            joinGameForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const playerName = joinGameForm['player-name'].value.trim();
                if (!playerName || !currentGameIdToJoin) return;
                
                const gameRef = doc(db, "spielrunden", currentGameIdToJoin);
                try {
                    await updateDoc(gameRef, {
                        participants: arrayUnion(playerName)
                    });
                    joinGameForm.reset();
                    hideModal(joinGameModal);
                    currentGameIdToJoin = null;
                } catch (error) {
                    console.error("Error joining game: ", error);
                }
            });
        }
    </script>
</body>
</html>
